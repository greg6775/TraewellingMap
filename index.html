<html>

<head>
    <script src="https://cdn.apple-mapkit.com/mk/5.x.x/mapkit.core.js" crossorigin async data-callback="initMapKit" data-libraries="full-map,services"></script>
</head>

<body>
    <div style="position:absolute;z-index: 69;">
        <input type="text" id="username" placeholder="Username" />
        <input type="text" id="accessToken" placeholder="Access Token (optional)" />
        <button onclick="showPolylines()">Fetch Polylines</button>
        <div id="status"></div>
    </div>
    <div id="mapDiv"></div>

    <script>
        const statusElem = document.getElementById("status")
        const tokenID = "eyJraWQiOiJSMzc0WTJSNzM3IiwidHlwIjoiSldUIiwiYWxnIjoiRVMyNTYifQ.eyJpc3MiOiJIODU2M1U2NDNCIiwiaWF0IjoxNzQzMzQ4ODc1LCJleHAiOjE3NDQwMDkxOTl9.Z7DwpefiK8qrmFQa11FgAy-kQ5NqWeE708spB7ZW5ATZHsXxnYWB64Wf_LlJXOKskkcXLSEFspZaKIklsCDINg";

        function initMapKit() {
            mapkit.init({
                authorizationCallback: function (done) {
                    done(tokenID);
                }
            });

            const coordinate = new mapkit.Coordinate(51, 10) // latitude, longitude
            const span = new mapkit.CoordinateSpan(20, 20)
            const region = new mapkit.CoordinateRegion(coordinate, span); // Europe with DE centered

            const map = new mapkit.Map("mapDiv", {
                region
            });
        }

        statusElem.innerText = "MapKit loaded"

        let rl = 0

        async function fetchStatuses(page = 1, previousResponse = []) {
            rl++
            if (rl == 61) {
                statusElem.innerText = "Sleeping to avoid ratelimit"
                await new Promise(r => setTimeout(r, 61000));
                rl = 0
            }
            return fetch(`https://traewelling.de/api/v1/user/${username.value}/statuses?page=${page}`, accessToken.value ? {
                headers: {
                    Authorization: "Bearer " + accessToken.value
                }
            } : {})
                .then(x => x.json())
                .then(res => {
                    const response = [ ...previousResponse, ...res.data ];

                    if (res.data.length !== 0) {
                        page++;

                        return fetchStatuses(page, response);
                    }

                    return response;
                });
        }

        async function showPolylines() {
            if (!username.value) {
                alert("Enter a name, mf")
                return
            }
            statusElem.innerText = "Fetching Statuses"
            const statuses = await fetchStatuses()
            const length = statuses.length
            for (var i = 0; i < statuses.length; i += 30) {
                const chunk = statuses.slice(i, i + 30);
                rl++
                statusElem.innerText = "Fetching Polyline " + i + "/" + length
                if (rl == 61) {
                    statusElem.innerText = "Sleeping to avoid ratelimit " + i + "/" + length
                    await new Promise(r => setTimeout(r, 61000));
                    rl = 0
                }
                const poly = await fetch(`https://traewelling.de/api/v1/polyline/${chunk.map(x => x.id).join(",")}`, accessToken.value ? {
                    headers: {
                        Authorization: "Bearer " + accessToken.value
                    }
                } : {}).then(x => x.json())
                for (const feature of poly.data.features) {
                    const points = feature.geometry.coordinates
                    var coords = points.map(function (point) {
                        return new mapkit.Coordinate(point[ 1 ], point[ 0 ]);
                    });

                    var style = new mapkit.Style({
                        lineWidth: 2,
                        lineJoin: "round",
                        strokeColor: "#F0F"
                    });


                    var polyline = new mapkit.PolylineOverlay(coords, { style });
                    map.addOverlay(polyline);
                }
            }
            statusElem.innerText = "Finished fetching"
        }
    </script>
</body>

</html>